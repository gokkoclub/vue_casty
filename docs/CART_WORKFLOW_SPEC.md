# カート & オーダーワークフロー仕様書

## 1. 概要
本システムの中核である「日付選択 → キャスト選択 → カート追加 → オーダー送信」の一連の流れを Vue/Firestore 環境へ完全移行するための仕様です。
現行の `index.html` における複雑な条件分岐やモーダル遷移のロジックを再現しつつ、データの保存先をスプレッドシートから Firestore に変更します。

---

## 2. ユーザーフロー図

```mermaid
graph TD
    A[カレンダー: 日付選択] --> B{撮影データあり?}
    
    B -->|Yes (撮影案件)| C[撮影案件モード]
    C --> D[キャスト選択画面]
    D --> E[カートに追加]
    E --> F[カートモーダル (撮影用)]
    
    B -->|No (データなし)| G[案件タイプ選択ダイアログ]
    G -->|外部案件| H[外部案件モード]
    G -->|社内イベント| I[社内イベントモード]
    G -->|戻る| A
    
    H --> D
    I --> D
    
    F --> J{カート種別判定}
    J -->|撮影案件| K[撮影情報保持して表示]
    J -->|外部/社内| L[案件情報入力フォーム表示]
    
    K --> M[オーダー送信]
    L --> M
    
    M --> N[Firestore保存 & Slack通知]
```

---

## 3. 詳細仕様

### 3.1 フェーズ1: 案件コンテキストの確定

ユーザーがカレンダー上の日付範囲を選択した時点の挙動です。

**要件:**
1. **撮影データの存在チェック**
   - 選択された日付（範囲含む）に合致する `shootings` コレクションのデータがあるか確認。
   - **データがある場合**: ユーザーに候補を提示し、選択させる。選択されたら「撮影案件モード」としてコンテキスト（作品名、監督名、NotionID等）を保持。
   - **データがない場合**: 「案件タイプ選択ダイアログ」を表示。

2. **案件タイプ選択ダイアログ**
   - 以下の選択肢を表示:
     - **外部案件**: 「その他」扱い。ユーザーが手動で案件名などを入力するフローへ。
     - **社内イベント**: 社内用の特別フロー。
     - **戻る**: 日付選択を解除してカレンダーに戻る。

**データ保持 (Store):**
```typescript
interface OrderContext {
  mode: 'shooting' | 'external' | 'internal';
  shootingData?: Shooting; // 撮影案件の場合のみ
  dateRanges: string[];    // 選択された日付範囲
}
```

### 3.2 フェーズ2: キャスト選択

コンテキストが確定した後、キャスト一覧画面に遷移（またはモーダル表示）します。

**要件:**
- キャストカードの「カートに追加」ボタンを押下。
- 既にカートに入っているキャストはボタンを非活性化。
- 既に出演決定済みやNGのキャストも視覚的に区別し、選択不可にする。

### 3.3 フェーズ3: カートモーダル (重要)

カートボタン押下時に開くモーダルの仕様です。保持している `OrderContext` によって表示内容が変化します。

#### A. 撮影案件モード (`mode: 'shooting'`)
- **ヘッダー**: 作品名、チーム名、監督名を表示（`shootingData` から自動表示）。編集不可（または補足のみ可）。
- **入力項目**: 役名、ランク、備考、メイン/サブ区分。
- **Notion連携**: 紐付いている Notion Page ID を内部で保持。

#### B. 外部案件/社内イベントモード (`mode: 'external' | 'internal'`)
- **ヘッダー**: 「外部案件」または「社内イベント」と表示。
- **入力項目**: 
  - **アカウント名**: 手動入力 (必須)
  - **作品名**: 手動入力 (必須)
  - **Notion URL**: 手動入力 (任意) -> 入力されたらID抽出して保持
  - その他項目 (役名、ランク等) は共通。

### 3.4 フェーズ4: カートの中身の動き

カート内でのアイテム操作仕様です。

**機能:**
1. **アイテム一覧表示**: 追加されたキャストをリスト表示。
2. **ドラッグ&ドロップ**: 優先順位（ランク）の並び替え。
3. **一括操作**: 複数の日付が選択されている場合、全日程に適用するか、特定の日程のみかを選択可能（現行仕様の複雑な部分）。
     - ※まずは「選択全日程に一括適用」を基本とし、個別調整はDB保存後に編集画面で行う形式を推奨します（複雑度軽減のため）。
4. **PDF添付**: 台本などのPDFファイルをアップロード可能。

**Firestore データモデル (カート一時保存用 - オプション):**
ページリロード対策として、カートの状態を `localStorage` または Firestore の `carts/{userId}` に保存することを推奨します。

```typescript
// Pinia Store で管理し、localStorage に persist する
state: {
  items: CartItem[];
  context: OrderContext;
  pdfFiles: File[]; // ※FileオブジェクトはStorageには入らないため、アップロード直前までJSメモリ管理
}
```

### 3.5 フェーズ5: オーダー送信とデータ保存

「送信」ボタン押下時の処理フローです。全ての書き込み先は **Firestore** になります。

**処理フロー:**
1. **バリデーション**: 必須項目（案件名、ランク等）のチェック。
2. **PDFアップロード** (ある場合): Cloud Storage for Firebase にアップロードし、URLを取得。
3. **Firestore 書き込み (`castings` collection)**:
   - カート内のアイテム数 × 日程数 分のドキュメントを作成。
   - Transaction または Batch Write を使用して整合性を担保。
   - **保存フィールド**:
     - `status`: 
       - 外部・撮影案件 → "オーダー待ち"
       - 社内イベント → "仮キャスティング" (または承認フローへ)
     - `projectId`: Notion Page ID (コンテキストから引き継ぎ)
     - その他 (`accountName`, `roleName`, `rank`, etc.)
4. **Cloud Functions トリガー**:
   - `onCreate` トリガーで Slack 通知を送信。
   - 内部キャストが含まれる場合、Google Calendar に仮ホールドを作成。

---

## 4. 移行における注意点

### 4.1 スプレッドシート独自ロジックの廃止
- **行挿入ロジック**: シートの「最終行に追加」や「特定行への挿入」といったロジックは不要になります。Firestore ではコレクションへの `add()` だけです。
- **数式 (ARRAYFORMULA等)**: シート側で計算していた値（年齢計算など）は、フロントエンドまたは保存時に計算して値として保存する必要があります。

### 4.2 案件タイプ選択のUX
現行ではデータがない場合にアラート的に聞いていますが、Vue 移行後はよりスムーズな UI（ダイアログやステッパー）で実装します。

### 4.3 状態管理 (State Management)
現行の `index.html` ではグローバル変数 (`window.cart`, `window.isAdditionalOrderMode`) に依存していましたが、移行後は **Pinia** ストアで厳格に管理します。

```typescript
// stores/orderStore.ts
export const useOrderStore = defineStore('order', {
  state: () => ({
    mode: null as 'shooting' | 'external' | 'internal' | null,
    context: null as OrderContext | null,
    cartItems: [] as CartItem[],
  }),
  actions: {
    setContext(ctx: OrderContext) {
      this.mode = ctx.mode;
      this.context = ctx;
    },
    addToCart(cast: Cast) { ... },
    reset() { ... }
  }
})
```

---

## 5. UI イメージ (コンポーネント構成)

- `CalendarView.vue`: 日付選択
- `OrderTypeDialog.vue`: 撮影データなし時の分岐
- `CastList.vue`: キャスト選択
- `CartModal.vue`: カート詳細・送信
  - `CartShootingInfo.vue`: 撮影案件時のヘッダー
  - `CartManualInfo.vue`: 外部案件時の入力フォーム
  - `CartItemList.vue`: ドラッグ可能なリスト

この仕様に基づき、Vue コンポーネントと Pinia ストアを設計・実装します。
