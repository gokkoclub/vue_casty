# オーダー連携ガイド（Slack通知・カレンダー・撮影連絡DB）

**更新日:** 2026年2月17日

---

## 📋 目次

1. [オーダー種類と連携一覧](#1-オーダー種類と連携一覧)
2. [新規オーダー](#2-新規オーダー)
3. [追加オーダー](#3-追加オーダー)
4. [特別オーダー（外部案件）](#4-特別オーダー外部案件)
5. [特別オーダー（社内イベント）](#5-特別オーダー社内イベント)
6. [ステータス更新通知](#6-ステータス更新通知)
7. [オーダー削除](#7-オーダー削除)
8. [特別オーダー編集](#8-特別オーダー編集)

---

## 1. オーダー種類と連携一覧

| オーダー種類 | Slack送信先 | スレッド | カレンダー | 撮影連絡DB | Notion同期 |
|---|---|---|---|---|---|
| 新規オーダー | `orderType`で振り分け | 新規投稿 | 内部キャスト → 仮ホールド | — | — |
| 追加オーダー | 元のスレッド | スレッド返信 | 内部キャスト → 仮ホールド | — | — |
| 特別（外部案件） | `SLACK_CHANNEL_EXTERNAL` | 新規投稿 | — | — | — |
| 特別（社内イベント） | `SLACK_DEFAULT_CHANNEL` | 新規投稿 | 内部キャスト → 仮ホールド | — | — |
| ステータス変更 | 元のスレッド | スレッド返信 | 下表参照 | 下表参照 | OK/決定時 |
| オーダー削除 | 元のスレッド | スレッド返信 | イベント削除 | — | — |

### Slackチャンネル振り分け（通常オーダー）

| `orderType` | チャンネル |
|---|---|
| `pattern_a` | `SLACK_CHANNEL_TYPE_A` |
| `pattern_b` | `SLACK_CHANNEL_TYPE_B` |
| `test` | `SLACK_CHANNEL_TEST` |

---

## 2. 新規オーダー

### API

`POST /api/notify/order_created` (`multipart/form-data`)

| パラメータ | 説明 |
|---|---|
| `payload_str` | `OrderCreatedPayload` JSON文字列 |
| `files` | PDF添付ファイル（複数可、任意） |

### Slackメッセージ

```
<!subteam^{MENTION_GROUP_ID}>
cc: {CCメンション}

キャスティングオーダーがありました。
*内部キャストはスタンプで反応ください*    ← 内部キャストがいる場合のみ

`撮影日`
・2024-12-25
・2024-12-26

`アカウント`
サンプルアカウント

`作品名`
サンプルCM/別作品

`役名`
【サンプルCM】
  主役
    第1候補：<@U12345678>：📝 備考あり
    🚨 同日に別の撮影があります
  脇役
    第1候補：<@U87654321>
    第2候補：田中太郎
【別作品】
  エキストラ
    第1候補：山田花子

`Notionリンク`
https://www.notion.so/xxxxxxxxxxxxx

--------------------------------------------------
```

### PDF添付時の処理

1. `files_upload_v2` でPDFアップロード（`initial_comment` にメッセージ本文）
2. レスポンスの `shares` から `ts` (スレッドID) を取得
3. 取得できない場合は `files.info` API で再取得（2秒待機）

### PDF添付なしの場合

1. `chat.postMessage` でテキスト送信
2. レスポンスから `ts` を取得

### カレンダー連携

- **内部キャストのみ**: フロントエンドで `createInternalHoldEvents()` を実行
- イベント形式: `[仮] キャスト名 / 案件名`（終日イベント）
- イベントIDをスプレッドシートに保存

### データ保存

- フロントエンドがスプレッドシート「キャスティングリスト」に書き込み
- `ts` と `permalink` をレコードに保存（シングルクォート付き `'ts`）

---

## 3. 追加オーダー

### 前提

- 既存のオーダー（同じアカウント名＋撮影日）が存在すること
- 元のオーダーの `slackThreadTs` を引き継ぐ

### API

同じ `POST /api/notify/order_created`（`isAdditionalOrder: true`、`slackThreadTs` 指定）

### Slackメッセージ（簡略フォーマット）

```
<!subteam^{MENTION_GROUP_ID}>

追加オーダーのお知らせ
*内部キャストはスタンプで反応ください*    ← 内部キャストがいる場合のみ

【サンプルCM】
主役：<@U12345678> / 田中太郎
  🚨 同日に別の撮影があります

【別作品】
脇役：<@U87654321>
```

### 新規オーダーとの違い

| 項目 | 新規オーダー | 追加オーダー |
|---|---|---|
| Slack投稿先 | 新規投稿 | 元のスレッドに返信 |
| ヘッダー | 「キャスティングオーダーがありました。」 | 「追加オーダーのお知らせ」 |
| CC欄 | あり | なし |
| 撮影日・アカウント・作品名 | セクション表示 | なし |
| 役名/候補の表示 | 階層構造（第N候補） | 横並び（`/` 区切り） |
| Notionリンク | あり | なし |
| 区切り線 | あり | なし |

### ステータス更新通知（追加オーダー時）

追加オーダー完了後、既存スレッドに以下も投稿される：

```
追加オーダーが登録されました。
{extraMessage}
```

### カレンダー連携

- 新規オーダーと同じ（内部キャストのみ仮ホールド作成）

---

## 4. 特別オーダー（外部案件）

### API

`POST /api/notify/special_order`

| パラメータ | 型 | 説明 |
|---|---|---|
| `orderType` | `"external"` | 外部案件 |
| `title` | string | タイトル |
| `dates` | string[] | 日程リスト |
| `startTime` | string | 開始時間 |
| `endTime` | string | 終了時間 |
| `castIds` | string[] | キャストIDリスト |
| `ordererEmail` | string | 作成者メール |

### Slackメッセージ

```
【外部案件】
`タイトル`
サンプルイベント
`日時`
2024/12/25, 2024/12/26
`時間`
10:00 ~ 18:00

`キャスト`
・<@U12345678>
・田中太郎

CC: <@U87654321>
```

### 連携

| 連携 | 動作 |
|---|---|
| Slack | `SLACK_CHANNEL_EXTERNAL` に1投稿（全キャストまとめ） |
| カレンダー | なし |
| スプレッドシート | バックエンドで直接書き込み（キャスト×日付分のレコード） |
| ステータス | 外部キャスト → **「決定」** / 内部キャスト → **「仮キャスティング」** |

---

## 5. 特別オーダー（社内イベント）

### API

同じ `POST /api/notify/special_order`（`orderType: "internal"`）

### Slackメッセージ

```
【社内イベント】
`タイトル`
社内撮影会
`日時`
2024/12/25
`時間`
10:00 ~ 18:00

`キャスト`
・<@U12345678> （内部）
・田中太郎

CC: <@U87654321>
```

### 連携

| 連携 | 動作 |
|---|---|
| Slack | `SLACK_DEFAULT_CHANNEL` に1投稿（全キャストまとめ） |
| カレンダー | **内部キャストのみ**: フロントエンドで仮ホールド作成 |
| スプレッドシート | バックエンドで直接書き込み（同上） |
| ステータス | 外部キャスト → **「決定」** / 内部キャスト → **「仮キャスティング」** |

### カレンダーイベント

- バックエンドが `calendar_events` 配列をレスポンスに含める
- フロントエンドが受け取って `createInternalHoldEvents()` を実行
- イベント形式: `[仮] キャスト名 / タイトル`（時間指定）

---

## 6. ステータス更新通知

### API

`POST /api/notify/status_update`

### Slackメッセージ

| ステータス | 絵文字 | メッセージ |
|---|---|---|
| OK / 決定 | ✅ | `✅ 田中太郎さん、出演 `OK` でした。` |
| NG | ❌ | `❌ 田中太郎さん、出演 `NG` でした。` |
| 条件つきOK | 🟡 | `🟡 田中太郎さん、出演 `条件つきOK` でした。` |
| 打診中 | 📩 | `📩 田中太郎さん、出演 `打診中` でした。` |
| 仮キャスティング | 📋 | `📋 田中太郎さん、出演 `仮キャスティング` でした。` |
| その他 | 📋 | `📋 田中太郎さん、出演 `{ステータス}` でした。` |
| 追加オーダー | — | `追加オーダーが登録されました。\n{extraMessage}` |

追加メッセージ（`extraMessage`）がある場合は本文の下に追記される。

### カレンダー連携（ステータス変更時）

| 新ステータス | カレンダー処理 |
|---|---|
| OK / 決定 | `[仮]` プレフィックスを削除 → `キャスト名 / 案件名` |
| NG / キャンセル | カレンダーイベントを削除 |
| 削除済み | カレンダーイベントを削除 |

### 撮影連絡DB

- ステータスが **「OK」** または **「決定」** に変更された場合
- **外部キャストのみ** 撮影連絡DBに自動追加（重複チェックあり）

### Notion同期

- ステータスが **「OK」** または **「決定」** に変更された場合
- `projectId` と `castName` がある場合のみ
- GAS経由でバックグラウンド実行

---

## 7. オーダー削除

### 通常オーダー

**API:** `POST /api/order/delete`

- 該当レコードのステータスを「削除済み」に更新
- Slackスレッドに削除通知
- `calendar_event_id` を返却 → フロントエンドでカレンダーイベント削除

### 特別オーダー

**API:** `POST /api/special_order/delete`

- 同じ `slackThreadTs` を持つ全レコードのステータスを「削除済み」に更新
- Slackスレッドに削除通知

---

## 8. 特別オーダー編集

**API:** `POST /api/special_order/update`

- `slackThreadTs` で完全一致検索
- スプレッドシート更新（タイトル、日程、時間、キャスト）
- Slackスレッドに更新通知
- 日程変更時はカレンダーイベントの削除→再作成が必要

---

## 付録: 実装箇所リファレンス

### バックエンド (`main.py`)

| 関数 | 行 | 処理内容 |
|---|---|---|
| `build_order_text()` | L185-296 | 新規/追加オーダーのSlackメッセージ生成 |
| `build_status_update_text()` | L298-329 | ステータス更新メッセージ生成 |
| `notify_order_created()` | L437-580 | 通常/追加オーダーのSlack送信 |
| `notify_special_order()` | L583-776 | 特別オーダーの全処理 |
| `notify_status_update()` | L779-810+ | ステータス更新Slack通知 + Notion同期 |
| `update_special_order()` | L1037+ | 特別オーダー更新 |
| `delete_special_order()` | L1186+ | 特別オーダー削除 |
| `delete_order()` | L1248+ | 通常オーダー削除 |

### フロントエンド (`templates/index.html`)

| 関数 | 処理内容 |
|---|---|
| `processNewOrder()` | オーダー送信（Slack通知 + シート書き込み） |
| `startAdditionalOrder()` | 追加オーダーモード開始 |
| `createInternalHoldEvents()` | カレンダー仮ホールド作成 |
| `changeCastingStatus()` | ステータス変更（カレンダー更新 + Slack通知 + 撮影連絡DB） |
| `openSpecialOrderModal()` | 特別オーダーモーダル表示 |
| `openEditSpecialOrderModal()` | 特別オーダー編集モーダル |
| `saveEditSpecialOrder()` | 特別オーダー編集保存 |
| `deleteCastingOrder()` | オーダー削除 |

### 関連ドキュメント

| ファイル | 内容 |
|---|---|
| [SLACK_NOTIFICATION_SPEC.md](file:///Users/mk0012/Desktop/casting-management-system-v1/docs/SLACK_NOTIFICATION_SPEC.md) | Slackメッセージ仕様の詳細 |
| [SYSTEM_SPECIFICATION.md](file:///Users/mk0012/Desktop/casting-management-system-v1/docs/SYSTEM_SPECIFICATION.md) | システム全体の仕様 |
| [BUG_ANALYSIS_20260210.md](file:///Users/mk0012/Desktop/casting-management-system-v1/docs/BUG_ANALYSIS_20260210.md) | カレンダー連携の既知バグ |
